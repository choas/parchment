(function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.ZVM=t()}})(function(){var t,e,r;return function n(t,e,r){function s(o,a){if(!e[o]){if(!t[o]){var _="function"==typeof require&&require;if(!a&&_)return _(o,!0);if(i)return i(o,!0);var h=Error("Cannot find module '"+o+"'");throw h.code="MODULE_NOT_FOUND",h}var c=e[o]={exports:{}};t[o][0].call(c.exports,function(e){var r=t[o][1][e];return s(r?r:e)},c,c.exports,n,t,e,r)}return e[o].exports}for(var i="function"==typeof require&&require,o=0;r.length>o;o++)s(r[o]);return s}({1:[function(t,e){function r(t,e,r){return r=r||{},e&&(r.func=e),t.subClass(r)}var n=t("../common/utils.js"),s=n.Class,i=n.U2S16,o=s.subClass({init:function(t,e){this.e=t,this.v=e},toString:function(){return this.v},U2S:function(){return i(this.v)}}),a=o.subClass({toString:function(){var t=this.v;return this.indirect?"e.indirect("+t+")":0===t?"s.pop()":15>--t?"l["+t+"]":"m.getUint16("+(this.e.globals+2*(t-15))+")"},store:function(t){var e=this.v;return this.indirect?"e.indirect("+e+","+t+")":this.returnval?"e.variable("+e+","+t+")":0===e?"s.push("+t+")":15>--e?"l["+e+"]="+t:"m.setUint16("+(this.e.globals+2*(e-15))+","+t+")"},U2S:function(){return"e.U2S("+this+")"}}),_=s.subClass({init:function(t,e,r,n,s,i){this.e=t,this.context=e,this.code=r,this.pc=n,this.labels=[this.pc+"/"+this.code],this.next=s,this.operands=i,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(t){return this.operands.join(t)},label:function(){return"/* "+this.labels.join()+" */ "}}),h=_.subClass({stopper:1}),c=h.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),u=s.subClass({init:function(t,e){this.ops=t||[],this.code=e||"||"},toString:function(){for(var t,e=0,r=[];this.ops.length>e;)t=this.ops[e++],r.push(t.func?(t.iftrue?"":"!(")+t.func.apply(t,t.operands)+(t.iftrue?"":")"):t);return(this.invert?"(!(":"(")+r.join(this.code)+(this.invert?"))":")")}}),l=_.subClass({brancher:1,keyword:"if",post:function(){var t,e,r=this.operands.pop(),n=r[1];this.iftrue=r[0],0===n||1===n?t="e.ret("+n+")":(n+=this.next-2,this.context.targets.push(n),t="e.pc="+n),this.result=t+";return",this.offset=n,this.cond=new u([this]),this.context.ops.length&&(e=this.context.ops.pop(),e.offset===n?(this.cond.ops.unshift(e.cond),this.labels=e.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(e))},toString:function(){var t=this.result;return t instanceof g&&(this.e.env.debug&&(t.context=this.context),t+=t.stopper?"; return":"",this.result.ops.length>1&&(t="\n"+t+"\n",this.e.env.debug&&(t+=this.context.spacer))),this.label()+this.keyword+this.cond+" {"+t+"}"}}),m=l.subClass({storer:1,post:function(){m.super.post.call(this),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),f=_.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var t=f.super.toString.call(this);return this.storer?this.storer.store(t):t}}),d=h.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),p=d.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),g=s.subClass({init:function(t,e){this.e=t,this.pc=e,this.pre=[],this.ops=[],this.post=[],this.targets=[],t.env.debug&&(this.spacer="")},toString:function(){return this.e.env.debug?(this.context&&(this.spacer=this.context.spacer+"  "),this.pre.join("")+(this.ops.length>1?this.spacer:"")+this.ops.join(";\n"+this.spacer)+this.post.join("")):this.pre.join("")+this.ops.join(";")+this.post.join("")}}),v=g.subClass({toString:function(){return this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n"),v.super.toString.call(this)}});e.exports={Operand:o,Variable:a,Opcode:_,Stopper:h,Pauser:c,BrancherLogic:u,Brancher:l,BrancherStorer:m,Storer:f,Caller:d,CallerStorer:p,Context:g,RoutineContext:v,opcode_builder:r}},{"../common/utils.js":3}],2:[function(t,e){function r(t,e){return t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3)}function n(t){return String.fromCharCode.call(null,255&t>>24,255&t>>16,255&t>>8,255&t)}var s=t("./utils.js"),i=s.Class,o=i.subClass({init:function(t){if(this.type="",this.chunks=[],t){if("FORM"!==t.substr(0,4))throw Error("Not an IFF file");this.type=t.substr(8,4);for(var e,n=12,s=t.length;s>n;){if(e=r(t,n+4),0>e||e+n>s)throw Error("IFF chunk out of range");this.chunks.push({type:t.substr(n,4),offset:n,data:t.substr(n+8,e)}),n+=8+e,e%2&&n++}}},write:function(){for(var t,e,r=this.type,s=0,i=this.chunks.length;i>s;)t=this.chunks[s++],e=t.data,r+=t.type+n(e.length)+e,e.length%2&&(r+="\0");return"FORM"+n(r.length)+r}}),a=o.subClass({init:function(t){if(this.super.init.call(t),t){if("IFZS"!==this.type)throw Error("Not a Quetzal savefile");for(var e,r,n=0,s=this.chunks.length;s>n;)e=this.chunks[n].type,r=this.chunks[n++].data,"CMem"===e||"UMem"===e?(this.memory=t,this.compressed="CMem"===e):"Stks"===e?this.stacks=t:"IFhd"===e&&(this.release=r.slice(0,2),this.serial=r.slice(2,8),this.checksum=r.slice(8,10),this.pc=r[10]<<16|r[11]<<8|r[12])}},write:function(){this.type="IFZS";var t=this.pc,e=this.release.concat(this.serial,this.checksum,255&t>>16,255&t>>8,255&t);return this.chunks=[{type:"IFhd",data:e},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this.super.write.call(this)}});e.exports={IFF:o,Quetzal:a}},{"./utils.js":3}],3:[function(t,e){function r(){for(var t,e,r=arguments[0],n=1;arguments.length>n;){t=arguments[n++];for(e in t)r[e]=t[e]}return r}function n(){}function s(t){return r(new DataView(t),{getBuffer8:function(t,e){return new Uint8Array(this.buffer.slice(t,t+e))},getBuffer16:function(t,e){return new Uint16Array(this.buffer.slice(t,t+2*e))},setBuffer8:function(t,e){new Uint8Array(this.buffer).set(e,t)}})}function i(t){return t<<16>>16}function o(t){return 65535&t}function a(t){for(var e=0,r=t.length,n=[];r>e;)n[e/2]=t[e++]<<8|t[e++];return n}n.subClass=function(t){function e(){this.init&&this.init.apply(this,arguments)}return e.prototype=r(Object.create(this.prototype),t),e.subClass=this.subClass,e.super=e.prototype.super=this.prototype,e},e.exports={extend:r,Class:n,MemoryView:s,U2S16:i,S2U16:o,byte_to_word:a}},{}],4:[function(t,e,r){var n=t("./common/utils.js"),s=n.Class,i=n.extend,o={init:function(){this.jit={},this.env={width:80}},inputEvent:function(t){var e,r=this.m,n=t.code;if(!t.env||(i(this.env,t.env),n)){if("load"===n)return this.data=new Uint8Array(t.data),void 0;this.orders=[],"restart"===n&&this.restart(),"save"===n&&this.variable(t.storer,t.result||1),"restore"===n&&(this.m||this.restart(),t.data?this.restore(t.data):this.variable(t.storer,0)),"read"===n&&(this.variable(t.storer,isNaN(t.terminator)?13:t.terminator),e=t.response,this._print(e+"\r"),e=this.text_to_zscii(e.toLowerCase()),e.length>t.len&&(e=e.slice(0,t.len)),r.setUint8(t.buffer+1,e.length),r.setBuffer8(t.buffer+2,e),t.parse&&this.tokenise(t.buffer,t.parse)),"char"===n&&this.variable(t.storer,this.keyinput(t.response)),"get_cursor"===n&&(r.setUint16(t.addr,t.pos[0]+1),r.setUint16(t.addr+2,t.pos[1]+1)),this.run()}},run:function(){var t,e,r=new Date,n=0;for(this.stop=0;!this.stop;)if(t=this.pc,this.jit[t]||this.compile(),e=this.jit[t](this),isNaN(e)||this.ret(e),0===++n%5e4&&new Date-r>5e3)return this.act("tick"),void 0},compile:function(){var t=this.disassemble(),e,r;this.env.debug?(e=""+t,r=eval("(0,function JIT_"+t.pc+"(e){"+e+"})"),r.context=t,r.code=e,t.name&&(r.name=t.name),this.jit[t.pc]=r):this.jit[t.pc]=Function("e",""+t),t.pc<this.staticmem&&this.warn("Caching a JIT function in dynamic memory: "+t.pc)},act:function(t,e){e=e||{},183===t&&(t="restart"),186===t&&(t="quit"),1001===t&&(t="restore",e={storer:e}),this.ui.flush(),this.ui.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),this.ui.status=[]),e.code=t,this.orders.push(e),this.stop=1,this.outputEvent&&this.outputEvent(this.orders)}},a=s.subClass(i(o,t("./zvm/runtime.js"),t("./zvm/text.js"),t("./zvm/disassembler.js")));e.exports=a},{"./common/utils.js":3,"./zvm/disassembler.js":5,"./zvm/runtime.js":7,"./zvm/text.js":8}],5:[function(t,e){var r=t("../common/ast.js"),n=t("./opcodes.js");e.exports.disassemble=function(){function t(t,e){for(var r=0;4>r;r++)e.push((192&t)>>6),t<<=2}for(var e,s,i,o,a,_,h,c=this.m,u=new r.RoutineContext(this,this.pc);;){if(s=e=this.pc,o=c.getUint8(e++),190===o?(_=-1,o=c.getUint8(e++)+1e3):128&o?64&o?(_=-1,32&o||(o&=31)):(_=[(48&o)>>4],3>_[0]&&(o&=207)):(_=[64&o?2:1,32&o?2:1],o&=31),!n[o])throw this.log(""+u),this.stop=1,Error("Unknown opcode #"+o+" at pc="+s);for(a=n[o].prototype,-1===_&&(_=[],t(c.getUint8(e++),_),(236===o||250===o)&&t(c.getUint8(e++),_)),h=[],i=0;_.length>i;)0===_[i]&&(h.push(new r.Operand(this,c.getUint16(e))),e+=2),1===_[i]&&h.push(new r.Operand(this,c.getUint8(e++))),2===_[i++]&&h.push(new r.Variable(this,c.getUint8(e++)));if(a.storer&&h.push(new r.Variable(this,c.getUint8(e++))),a.brancher&&(i=c.getUint8(e++),h.push([128&i,64&i?63&i:(i<<8|c.getUint8(e++))<<18>>18])),a.printer)for(h.push(e);this.eof>e&&(i=c.getUint8(e),e+=2,!(128&i)););if(this.pc=e,u.ops.push(new n[o](this,u,o,s,e,h)),i=0,a.stopper&&!i)break}return u}},{"../common/ast.js":1,"./opcodes.js":6}],6:[function(t,e){var r=t("../common/ast.js"),n=r.Variable,s=r.Opcode,i=r.Stopper,o=r.Pauser,a=r.Brancher,_=r.BrancherStorer,h=r.Storer,c=r.Caller,u=r.CallerStorer,l=r.opcode_builder,m=function(t){return""+t},f=l(r.Brancher,function(){return 1}),d=r.Storer.subClass({storer:0,post:function(){var t=this.operands,e=t[0],r=e instanceof n;t[0]=new n(this.e,r?e:e.v),(r||0===e.v)&&(t[0].indirect=1),this.storer=142===this.code?t.pop():t.shift(),0===t.length&&t.push(new n(this.e,0))},func:m}),p=s.subClass({func:function(t){var e=t.v-1,r=this.code%2?1:-1;return t instanceof n||e>14?"e.incdec("+t+","+r+")":(0>e?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":"e.l["+e+"]=e.S2U(e.l["+e+"]+")+r+")"}});e.exports={1:l(a,function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:l(a,function(t,e){return t.U2S()+"<"+e.U2S()}),3:l(a,function(t,e){return t.U2S()+">"+e.U2S()}),4:l(a,function(t,e){return"e.U2S(e.incdec("+t+",-1))<"+e.U2S()}),5:l(a,function(t,e){return"e.U2S(e.incdec("+t+",1))>"+e.U2S()}),6:l(a,function(){return"e.jin("+this.args()+")"}),7:l(a,function(){return"e.test("+this.args()+")"}),8:l(h,function(){return this.args("|")}),9:l(h,function(){return this.args("&")}),10:l(a,function(){return"e.test_attr("+this.args()+")"}),11:l(s,function(){return"e.set_attr("+this.args()+")"}),12:l(s,function(){return"e.clear_attr("+this.args()+")"}),13:d,14:l(s,function(){return"e.insert_obj("+this.args()+")"}),15:l(h,function(t,e){return"m.getUint16(e.S2U("+t+"+2*"+e.U2S()+"))"}),16:l(h,function(t,e){return"m.getUint8(e.S2U("+t+"+"+e.U2S()+"))"}),17:l(h,function(){return"e.get_prop("+this.args()+")"}),18:l(h,function(){return"e.find_prop("+this.args()+")"}),19:l(h,function(){return"e.find_prop("+this.args(",0,")+")"}),20:l(h,function(){return"e.S2U("+this.args("+")+")"}),21:l(h,function(){return"e.S2U("+this.args("-")+")"}),22:l(h,function(){return"e.S2U("+this.args("*")+")"}),23:l(h,function(t,e){return"e.S2U(parseInt("+t.U2S()+"/"+e.U2S()+"))"}),24:l(h,function(t,e){return"e.S2U("+t.U2S()+"%"+e.U2S()+")"}),25:u,26:c,27:l(s,function(){return"e.ui.set_colour("+this.args()+")"}),28:l(i,function(t,e){return"while(e.call_stack.length>"+e+"){e.call_stack.shift()}return "+t}),128:l(a,function(t){return t+"===0"}),129:l(_,function(t){return"e.get_sibling("+t+")"}),130:l(_,function(t){return"e.get_child("+t+")"}),131:l(h,function(t){return"e.get_parent("+t+")"}),132:l(h,function(t){return"e.get_prop_len("+t+")"}),133:p,134:p,135:l(s,function(t){return"e.print(2,"+t+")"}),136:u,137:l(s,function(t){return"e.remove_obj("+t+")"}),138:l(s,function(t){return"e.print(3,"+t+")"}),139:l(i,function(t){return"return "+t}),140:l(i,function(t){return"e.pc="+t.U2S()+"+"+(this.next-2)}),141:l(s,function(t){return"e.print(2,"+t+"*"+this.e.addr_multipler+")"}),142:d.subClass({storer:1}),143:c,176:l(i,function(){return"return 1"}),177:l(i,function(){return"return 0"}),178:l(s,function(t){return"e.print(2,"+t+")"},{printer:1}),179:l(i,function(t){return"e.print(2,"+t+");e.print(1,13);return 1"},{printer:1}),180:s,183:l(i,function(){return"e.act(183)"}),184:l(i,function(t){return"return "+t},{post:function(){this.operands.push(new n(this.e,0))}}),185:l(h,function(){return"e.call_stack.length"}),186:l(i,function(){return"e.act(186)"}),187:l(s,function(){return"e.print(1,13)"}),189:f,191:f,224:u,225:l(s,function(t,e,r){return"m.setUint16(e.S2U("+t+"+2*"+e.U2S()+"),"+r+")"}),226:l(s,function(t,e,r){return"m.setUint8(e.S2U("+t+"+"+e.U2S()+"),"+r+")"}),227:l(s,function(){return"e.put_prop("+this.args()+")"}),228:l(o,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:l(s,function(t){return"e.print(4,"+t+")"}),230:l(s,function(t){return"e.print(0,"+t.U2S()+")"}),231:l(h,function(t){return"e.random("+t.U2S()+")"}),232:l(h,m,{post:function(){this.storer=new n(this.e,0)},storer:0}),233:d,234:l(s,function(t){return"e.ui.split_window("+t+")"}),235:l(s,function(t){return"e.ui.set_window("+t+")"}),236:u,237:l(s,function(t){return"e.ui.erase_window("+t.U2S()+")"}),238:l(s,function(t){return"e.ui.erase_line("+t+")"}),239:l(s,function(){return"e.ui.set_cursor("+this.args()+")"}),240:l(o,function(t){return"e.ui.get_cursor("+t+")"}),241:l(s,function(t){return"e.ui.set_style("+t+")"}),242:s,243:l(s,function(){return"e.output_stream("+this.args()+")"}),244:s,245:s,246:l(o,function(){return"e.read_char("+(this.args()||"1")+","+this.storer.v+")"}),247:l(_,function(){return"e.scan_table("+this.args()+")"}),248:l(h,function(t){return"e.S2U(~"+t+")"}),249:c,250:c,251:l(s,function(){return"e.tokenise("+this.args()+")"}),252:l(s,function(){return"e.encode_text("+this.args()+")"}),253:l(s,function(){return"e.copy_table("+this.args()+")"}),254:l(s,function(){return"e.print_table("+this.args()+")"}),255:l(a,function(t){return t+"<=e.call_stack[0][4]"}),1e3:l(o,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:l(o,function(){return"e.act(1001,"+this.storer.v+")"}),1002:l(h,function(t,e){return"e.S2U(e.log_shift("+t+","+e.U2S()+"))"}),1003:l(h,function(t,e){return"e.S2U(e.art_shift("+t.U2S()+","+e.U2S()+"))"}),1004:l(h,function(t){return"e.ui.set_font("+t+")"}),1009:l(h,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:l(s,function(){return"if(e.restore_undo())return"},{storer:1}),1011:l(s,function(t){return"e.print(1,"+t+")"}),1012:l(h,function(){return 3}),1013:l(s,function(){return"e.ui.set_true_colour("+this.args()+")"}),1014:s.subClass({brancher:1}),1030:l(h,function(){return"e.gestalt("+this.args()+")"})}},{"../common/ast.js":1}],7:[function(t,e){var r=t("../common/utils.js"),n=r.extend,s=r.U2S16,i=r.S2U16,o=r.byte_to_word,a=t("../common/file.js");e.exports={art_shift:function(t,e){return e>0?t<<e:t>>-e},call:function(t,e,r,n){if(0===t)return e>=0&&this.variable(e,0),this.pc=r;var s,i,o=this.l.length,a=n.length;for(this.pc=t*this.addr_multipler,i=this.m.getUint8(this.pc++),n=n.slice(0,i),s=n.length;i>s;s++)n.push(0);this.l=n.concat(this.l),this.call_stack.unshift([r,e,i,this.s.length,a,o])},clear_attr:function(t,e){var r=0|this.objects+14*t+e/8;this.m.setUint8(r,this.m.getUint8(r)&~(128>>e%8))},copy_table:function(t,e,r){r=s(r);var n=this.m,i=0,o=0>r;if(r=Math.abs(r),0!==e)if(o)for(;r>i;)n.setUint8(e+i,n.getUint8(t+i++));else n.setBuffer8(e,n.getBuffer8(t,r));else for(;r>i;)n.setUint8(t+i++,0)},encode_text:function(t,e,r,n){this.m.setBuffer8(n,this.encode(this.m.getBuffer8(t+r,e)))},extension_table:function(t,e){var r=this.extension;return!r||t>this.extension_count?0:(r+=2*t,void 0===e?this.m.getUint16(r):(this.e.setUint16(r,e),void 0))},find_prop:function(t,e,r){var n,s,i=this.m,o=0,a=i.getUint16(this.objects+14*t+12);for(a+=2*i.getUint8(a)+1;;){if(n=i.getUint8(a),s=63&n,o===r)return s;if(s===e)return a+(128&n?2:1);if(e>s)return 0;o=s,128&n?(s=63&i.getUint8(a+1),a+=s?s+2:66):a+=64&n?3:2}},gestalt:function(t){switch(t){case 1:return 258;case 8192:return 1;case 8193:case 8194:return 2}return 0},get_child:function(t){return this.m.getUint16(this.objects+14*t+10)},get_sibling:function(t){return this.m.getUint16(this.objects+14*t+8)},get_parent:function(t){return this.m.getUint16(this.objects+14*t+6)},get_prop:function(t,e){var r=this.m,n=this.find_prop(t,e);return n?r[64&r.getUint8(n-1)?"getUint16":"getUint8"](n):r.getUint16(this.properties+2*(e-1))},get_prop_len:function(t){if(0===t)return 0;var e=this.m.getUint8(t-1);return 128&e?(e&=63,0===e?64:e):64&e?2:1},incdec:function(t,e){var r,n;return 0===t?(r=i(this.s.pop()+e),this.s.push(r),r):15>--t?this.l[t]=i(this.l[t]+e):(n=this.globals+2*(t-15),r=this.m.getUint16(n)+e,this.m.setUint16(n,r),r)},indirect:function(t,e){return 0===t?arguments.length>1?this.s[this.s.length-1]=e:this.s[this.s.length-1]:this.variable(t,e)},insert_obj:function(t,e){this.remove_obj(t),this.set_family(t,e,e,t,t,this.get_child(e))},jeq:function(){for(var t=1;arguments.length>t;)if(arguments[t++]===arguments[0])return 1},jin:function(t,e){return this.get_parent(t)===e},log:function(){this.env.debug&&"undefined"!=typeof console&&console.log&&console.log.apply(console,arguments)},log_shift:function(t,e){return e>0?t<<e:t>>>-e},output_stream:function(t,e){if(t=s(t),1===t&&(this.streams[0]=1),-1===t&&(this.log("Disabling stream one - it actually happened!"),this.streams[0]=0),3===t&&this.streams[2].unshift([e,""]),-3===t){var r=this.streams[2].shift(),n=this.text_to_zscii(r[1]);this.m.setUint16(r[0],n.length),this.m.setBuffer8(r[0]+2,n)}},_print:function(t){if(this.streams[2].length)this.streams[2][0][1]+=t;else if(this.streams[0]){var e=2&this.m.getUint8(17);e!==(2&this.ui.mono)&&(253&this.ui.mono||this.ui.flush(),this.ui.mono^=2),this.ui.buffer+=t}},print:function(t,e){if(0===t&&(e=""+e),1===t&&(e=String.fromCharCode(e)),2===t&&(e=this.jit[e]||this.decode(e)),3===t){var r=this.m.getUint16(this.objects+14*e+12);e=this.decode(r+1,2*this.m.getUint8(r))}if(4===t){if(!this.unicode_table[e])return;e=this.unicode_table[e]}this._print(e)},print_table:function(t,e,r,n){r=r||1,n=n||0;for(var s=0;r>s++;)this._print(this.zscii_to_text(this.m.getBuffer8(t,e))+(r>s?"\r":"")),t+=e+n},put_prop:function(t,e,r){var n=this.m,s=this.find_prop(t,e);n[64&n.getUint8(s-1)?"setUint16":"setUint8"](s,r)},random:function(t){var e=this.xorshift_seed;return 1>t?(this.xorshift_seed=t,0):0===e?0|1+Math.random()*t:(e^=e<<13,e^=e>>17,this.xorshift_seed=e^=e<<5,1+(32767&e)%t)},read:function(t,e,r,n,s){3===arguments.length&&(s=r,r=n=0),this.act("read",{buffer:t,parse:e,len:this.m.getUint8(t),initiallen:this.m.getUint8(t+1),time:r,routine:n,storer:s})},read_char:function(t,e,r,n){2===arguments.length&&(n=e,e=r=0),this.act("char",{time:e,routine:r,storer:n})},remove_obj:function(t){var e,r,n,s=this.get_parent(t);if(0!==s)if(e=this.get_child(s),r=this.get_sibling(t),e===t)this.set_family(t,0,s,r);else{for(;;){if(n=this.get_sibling(e),n===t)break;e=n}this.set_family(t,0,0,0,e,r)}},restart:function(){var e=r.MemoryView(this.data.slice().buffer),s=e.getUint8(0),i=5===s?4:8,o=e.getUint16(10),a=e.getUint16(54);if(5!==s&&8!==s)throw Error("Unsupported Z-Machine version: "+s);this.m&&e.setUint8(17,this.m.getUint8(17)),n(this,{m:e,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:s,pc:e.getUint16(6),properties:o,objects:o+112,globals:e.getUint16(12),staticmem:e.getUint16(14),eof:(e.getUint16(26)||65536)*i,extension:a,extension_count:a?e.getUint16(a):0,addr_multipler:i}),this.ui=new(t("./ui.js"))(this,2&e.getUint8(17)),this.init_text(),this.update_header()},restore:function(t){var e,r,n=new a.Quetzal(t),s=n.memory,i=n.stacks,_=n.pc,h=this.m.getUint8(17),c=0,u=0,l=[],m=[];if(this.m.setBuffer8(0,this.data.slice(0,this.staticmem)),n.compressed)for(;s.length>c;)e=s[c++],0===e?u+=1+s[c++]:this.m.setUint8(u,e^this.data[u++]);else this.m.setBuffer8(0,s);for(this.m.setUint8(17,h),c=6,e=i[c++]<<8|i[c++],r=o(i.slice(c,e));i.length>c;){for(l.unshift([i[c++]<<16|i[c++]<<8|i[c++],0,0,r.length,0,m.length]),l[0][1]=16&i[c]?-1:i[c+1],l[0][2]=15&i[c],c+=2,e=i[c++];e;)l[0][4]++,e>>=1;e=2*(i[c++]<<8|i[c++]),m=o(i.slice(c,c+=2*l[0][2])).concat(m),r=r.concat(o(i.slice(c,c+=e)))}this.call_stack=l,this.l=m,this.s=r,this.update_header(),this.variable(this.m.getUint8(_++),2),this.pc=_},restore_undo:function(){if(0===this.undo.length)return 0;var t=this.undo.pop();return this.pc=t[0],t[2][17]=this.m.getUint8(17),this.m.setBuffer8(0,t[2]),this.l=t[3],this.s=t[4],this.call_stack=t[5],this.variable(t[1],2),1},ret:function(t){var e=this.call_stack.shift(),r=e[1];this.pc=e[0],this.l=this.l.slice(this.l.length-e[5]),this.s.length=e[3],r>=0&&this.variable(r,0|t)},save:function(t,e){var r,n,s,i,o,_=this.m,h=this.s,c=this.l,u=new a.Quetzal,l=[],m=0,f=this.call_stack.reverse(),d=[0,0,0,0,0,0];for(u.release=_.getBuffer8(2,2),u.serial=_.getBuffer8(18,6),u.checksum=_.getBuffer8(28,2),u.pc=t,u.compressed=1,r=0;this.staticmem>r;r++)s=_.getUint8(r)^this.data[r],0===s?256===++m&&(l.push(0,255),m=0):(m&&(l.push(0,m-1),m=0),l.push(s));for(u.memory=l,d.push(f[0][3]>>8,255&f[0][3]),n=0;f[0][3]>n;n++)d.push(h[n]>>8,255&h[n]);for(r=0;f.length>r;r++){for(i=f[r],o=(f[r+1]?f[r+1][3]:h.length)-i[3],d.push(i[0]>>16,255&i[0]>>8,255&i[0],i[2]|(0>i[1]?16:0),0>i[1]?0:i[1],(1<<i[4])-1,o>>8,255&o),n=c.length-i[5]-i[2];c.length-i[5]>n;n++)d.push(c[n]>>8,255&c[n]);for(n=i[3];i[3]+o>n;n++)d.push(h[n]>>8,255&h[n])}f.reverse(),u.stacks=d,this.act("save",{data:u.write(),storer:e})},save_undo:function(t,e){return this.undo.push([t,e,this.m.getBuffer8(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]),1},scan_table:function(t,e,r,n){n=n||130;var s=128&n?"getUint16":"getUint8";for(n&=127,r=e+r*n;r>e;){if(this.m[s](e)===t)return e;e+=n}return 0},set_attr:function(t,e){var r=0|this.objects+14*t+e/8;this.m.setUint8(r,this.m.getUint8(r)|128>>e%8)},set_family:function(t,e,r,n,s,i){this.m.setUint16(this.objects+14*t+6,e),r&&this.m.setUint16(this.objects+14*r+10,n),s&&this.m.setUint16(this.objects+14*s+8,i)},test:function(t,e){return t&e===e},test_attr:function(t,e){return 128&this.m.getUint8(0|this.objects+14*t+e/8)<<e%8},update_header:function(){var t=this.m;this.xorshift_seed=0,t.setUint8(1,29|(this.env.timed?128:0)),t.setUint8(17,87&t.getUint8(17)),t.setUint8(32,255),t.setUint8(33,this.env.width),t.setUint16(34,this.env.width),t.setUint16(36,255),t.setUint16(38,257),t.setUint16(50,258),this.extension_table(4,0),this.ui.update_header()},variable:function(t,e){var r,n=void 0!==e;if(0===t){if(!n)return this.s.pop();this.s.push(e)}else if(15>--t){if(!n)return this.l[t];this.l[t]=e}else{if(r=this.globals+2*(t-15),!n)return this.m.getUint16(r);this.m.setUint16(r,e)}return e},warn:function(){this.env.debug&&"undefined"!=typeof console&&console.warn&&console.warn.apply(console,arguments)},U2S:s,S2U:i}},{"../common/file.js":2,"../common/utils.js":3,"./ui.js":9}],8:[function(t,e){e.exports={init_text:function(){function t(t){for(var e=[[],[],[]],n=0;78>n;)e[0|n/26][n%26]=t[n++];e[2][1]=13,r.alphabets=e}function e(t){for(var e={13:"\r"},n={13:13},s=0;t.length>s;)e[155+s]=String.fromCharCode(t[s]),n[t[s]]=155+s++;for(s=32;127>s;)e[s]=String.fromCharCode(s),n[s]=s++;r.unicode_table=e,r.reverse_unicode_table=n}var r=this,n=this.m,s=n.getUint16(52),i=this.extension_table(3),o=i&&n.getUint8(i++);t(s?n.getBuffer8(s,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),e(i?n.getBuffer16(i,o):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=n.getUint16(8),this.parse_dict(this.dict)},decode:function(t,e){var r,n,s,i,o=this.m,a=t,_=[],h=0,c=0,u=[],l=[],m=0;if(this.jit[t])return this.jit[t];for(e=e?e+t:this.eof;e>t&&(r=o.getUint16(t),t+=2,_.push(31&r>>10,31&r>>5,31&r),!(32768&r)););for(;_.length>h;){if(n=_[h++],0===n)u.push(32);else if(4>n)s=1,u.push(-1),l.push("\ue000+this.abbr("+(32*(n-1)+_[h++])+")+\ue000");else if(6>n)c=n;else if(2===c&&6===n){if(_.length>h+1)if(i=_[h++]<<5|_[h++],768>i)u.push(i);else{for(i-=767,m+=i,r=h,h=h%3+3;i--;)u.push(-1),l.push(String.fromCharCode(_[h]<<10|_[h+1]<<5|_[h+2])),_[h++]=_[h++]=_[h++]=32;h=r}}else 32>n&&u.push(this.alphabets[c][n-6]);c=4>c?0:c-3,0===h%3&&(h+=m,m=0)}return u=this.zscii_to_text(u,l),s&&(u={toString:Function('return"'+u.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"').bind(this)}),a>=this.staticmem&&(this.jit[a]=u),u},encode:function(t){for(var e,r,n=this.alphabets,s=[],i=0,o=[];9>s.length;)e=t[i++],32===e?s.push(0):(r=n[0].indexOf(e))>=0?s.push(r+6):(r=n[1].indexOf(e))>=0?s.push(4,r+6):(r=n[2].indexOf(e))>=0?s.push(5,r+6):(r=this.reverse_unicode_table[e])?s.push(5,6,r>>5,31&r):void 0===e&&s.push(5);for(s.length=9,i=0;9>i;)o.push(s[i++]<<2|s[i]>>3,(7&s[i++])<<5|s[i++]);return o[4]|=128,o},zscii_to_text:function(t,e){for(var r,n=0,s=t.length,i=0,o="";s>n;)r=t[n++],-1===r&&(o+=e[i++]),(r=this.unicode_table[r])&&(o+=r);return o},text_to_zscii:function(t,e){for(var r,n=[],s=0,i=t.length;i>s;)r=t.charCodeAt(s++),e||(r=this.reverse_unicode_table[r]||63),n.push(r);return n},parse_dict:function(t){var e,r,n=this.m,s=t,i={},o=n.getUint8(t++);for(i.separators=n.getBuffer8(t,o),t+=o,e=n.getUint8(t++),r=t+2+e*n.getUint16(t),t+=2;r>t;)i[""+n.getBuffer8(t,6)]=t,t+=e;return this.dictionaries[s]=i,i},abbr:function(t){var e=this.m;return this.decode(2*e.getUint16(e.getUint16(24)+2*t))},tokenise:function(t,e,r,n){r=r||this.dict,r=this.dictionaries[r]||this.parse_dict(r);for(var s,i,o=this.m,a=2,_=a+o.getUint8(t+1),h=r.separators,c=[],u=[],l=a,m=0;_>a;)s=o.getUint8(t+a++),32===s||h.indexOf(s)>=0?(c.length&&(u.push([c,l]),l+=c.length,c=[]),32!==s&&u.push([[s],l]),l++):c.push(s);for(c.length&&u.push([c,l]),i=Math.min(u.length,o.getUint8(e));i>m;)c=r[""+this.encode(u[m][0])],(!n||c)&&(o.setUint16(e+2+4*m,c||0),o.setUint8(e+4+4*m,u[m][0].length),o.setUint8(e+5+4*m,u[m][1])),m++;o.setUint8(e+1,m)},keyinput:function(t){var e=t.charCode,r=t.keyCode,n=function(){for(var t={8:8,13:13,27:27,37:131,38:129,39:132,40:130},e=96;106>e;)t[e]=49+e++;for(e=112;124>e;)t[e]=21+e++;return t}();return n[r]?n[r]:this.reverse_unicode_table[e]||63}}},{}],9:[function(t,e){var r=t("../common/utils.js"),n=r.Class;e.exports=n.subClass({init:function(t,e){this.e=t,this.buffer="",r.extend(this,this.formatters[t.env.formatter]||{}),this.e.env.debug&&(this.reverse=0,this.bold=0,this.italic=0,this.fg=void 0,this.bg=void 0),this.mono=e,this.process_colours(),this.currentwin=0,this.status=[],t.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",bg:this.bg})},erase_line:function(t){1===t&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(t){this.flush(),1>t&&this.clear_window(),-1===t&&this.split_window(0),(-2===t||1===t)&&this.status.push({code:"clear"})},flush:function(){if(""!==this.buffer){var t={code:"stream",text:this.buffer,props:this.format()};(this.currentwin?this.status:this.e.orders).push(t),this.buffer=""}},format:function(){var t,e={},r=[],n=this.fg,s=this.bg;return this.bold&&r.push("zvm-bold"),this.italic&&r.push("zvm-italic"),this.mono&&r.push("zvm-mono"),this.reverse&&(t=n,n=s||this.env.bg,s=t||this.env.fg),n!==void 0&&(isNaN(n)?e.css={color:n}:r.push("zvm-fg-"+n)),s!==void 0&&(isNaN(s)?(e.css||(e.css={}),e.css["background-color"]=s):r.push("zvm-bg-"+s)),r.length&&(e["class"]=r.join(" ")),e},get_cursor:function(t){this.status.push({code:"get_cursor",addr:t}),this.e.act()},process_colours:function(){function t(t){var e,r=Math.round,n=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(t);return n[1]?e=[n[1],n[2],n[3]]:(e=[parseInt(n[4],16),parseInt(n[5],16),parseInt(n[6],16)],4===t.length&&(e=[e[0]<<4|e[0],e[1]<<4|e[1],e[2]<<4|e[2]])),r(e[2]/8.226)<<10|r(e[1]/8.226)<<5|r(e[0]/8.226)}var e=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],r=this.e.env.fgcolour,n=this.e.env.bgcolour,s=r?t(r):65535,i=n?t(n):65535,o=e.indexOf(s),a=e.indexOf(i);2>o&&(o=r||2),2>a&&(a=n||9),this.env={fg:o,bg:a,fg_true:s,bg_true:i}},set_colour:function(t,e){this.flush(),1===t&&(this.fg=void 0),t>1&&13>t&&(this.fg=t),1===e&&(this.bg=void 0),e>1&&13>e&&(this.bg=e)},set_cursor:function(t,e){this.flush(),this.status.push({code:"cursor",to:[t-1,e-1]})},set_font:function(t){if(1!==t&&4!==t)return 0;var e=4&this.mono?4:1;return t!==e&&(this.flush(),this.mono^=4),e},set_style:function(t){this.flush(),0===t&&(this.reverse=this.bold=this.italic=0,this.mono&=254),1&t&&(this.reverse=1),2&t&&(this.bold=1),4&t&&(this.italic=1),8&t&&(this.mono|=1)},set_true_colour:function(t,e){function r(t){var e=Math.round(8.226*(31&t))<<16|Math.round(8.226*((992&t)>>5))<<8|Math.round(8.226*((31744&t)>>10));for(e=e.toString(16);6>e.length;)e="0"+e;return"#"+e}this.flush(),65535===t?this.fg=void 0:32768>t&&(this.fg=r(t)),65535===e?this.bg=void 0:32768>e&&(this.bg=r(e))},set_window:function(t){this.flush(),this.currentwin=t,this.e.orders.push({code:"find",name:t?"status":"main"}),t&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(t){this.flush(),this.status.push({code:"height",lines:t})},update_header:function(){var t=this.e.m;t.setUint8(44,isNaN(this.env.bg)?1:this.env.bg),t.setUint8(45,isNaN(this.env.fg)?1:this.env.fg),this.e.extension_table(5,this.env.fg_true),this.e.extension_table(6,this.env.bg_true)},formatters:{}})},{"../common/utils.js":3}]},{},[4])(4)});