(function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.ZVM=t()}})(function(){var t,e,r;return function s(t,e,r){function n(o,a){if(!e[o]){if(!t[o]){var _="function"==typeof require&&require;if(!a&&_)return _(o,!0);if(i)return i(o,!0);var h=Error("Cannot find module '"+o+"'");throw h.code="MODULE_NOT_FOUND",h}var c=e[o]={exports:{}};t[o][0].call(c.exports,function(e){var r=t[o][1][e];return n(r?r:e)},c,c.exports,s,t,e,r)}return e[o].exports}for(var i="function"==typeof require&&require,o=0;r.length>o;o++)n(r[o]);return n}({1:[function(t,e){function r(t,e,r){return r=r||{},e&&(r.func=e),t.subClass(r)}var s=t("../common/utils.js"),n=s.Class,i=s.U2S16,o=n.subClass({init:function(t,e){this.e=t,this.v=e},toString:function(){return this.v},U2S:function(){return i(this.v)}}),a=o.subClass({toString:function(){var t=this.v;return this.indirect?"e.indirect("+t+")":0===t?"s.pop()":15>--t?"l["+t+"]":"m.getUint16("+(this.e.globals+2*(t-15))+")"},store:function(t){var e=this.v;return this.indirect?"e.indirect("+e+","+t+")":this.returnval?"e.variable("+e+","+t+")":0===e?"s.push("+t+")":15>--e?"l["+e+"]="+t:"m.setUint16("+(this.e.globals+2*(e-15))+","+t+")"},U2S:function(){return"e.U2S("+this+")"}}),_=n.subClass({init:function(t,e,r,s,n,i){this.e=t,this.context=e,this.code=r,this.pc=s,this.labels=[this.pc+"/"+this.code],this.next=n,this.operands=i,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(t){return this.operands.join(t)},label:function(){return"/* "+this.labels.join()+" */ "}}),h=_.subClass({stopper:1}),c=h.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),u=n.subClass({init:function(t,e){this.ops=t||[],this.code=e||"||"},toString:function(){for(var t,e=0,r=[];this.ops.length>e;)t=this.ops[e++],r.push(t.func?(t.iftrue?"":"!(")+t.func.apply(t,t.operands)+(t.iftrue?"":")"):t);return(this.invert?"(!(":"(")+r.join(this.code)+(this.invert?"))":")")}}),l=_.subClass({brancher:1,keyword:"if",post:function(){var t,e,r=this.operands.pop(),s=r[1];this.iftrue=r[0],0===s||1===s?t="e.ret("+s+")":(s+=this.next-2,this.context.targets.push(s),t="e.pc="+s),this.result=t+";return",this.offset=s,this.cond=new u([this]),this.context.ops.length&&(e=this.context.ops.pop(),e.offset===s?(this.cond.ops.unshift(e.cond),this.labels=e.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(e))},toString:function(){var t=this.result;return t instanceof g&&(this.e.env.debug&&(t.context=this.context),t+=t.stopper?"; return":"",this.result.ops.length>1&&(t="\n"+t+"\n",this.e.env.debug&&(t+=this.context.spacer))),this.label()+this.keyword+this.cond+" {"+t+"}"}}),m=l.subClass({storer:1,post:function(){m.super.post.call(this),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),f=_.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var t=f.super.toString.call(this);return this.storer?this.storer.store(t):t}}),d=h.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),p=d.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),g=n.subClass({init:function(t,e){this.e=t,this.pc=e,this.pre=[],this.ops=[],this.post=[],this.targets=[],t.env.debug&&(this.spacer="")},toString:function(){return this.e.env.debug?(this.context&&(this.spacer=this.context.spacer+"  "),this.pre.join("")+(this.ops.length>1?this.spacer:"")+this.ops.join(";\n"+this.spacer)+this.post.join("")):this.pre.join("")+this.ops.join(";")+this.post.join("")}}),v=g.subClass({toString:function(){return this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n"),v.super.toString.call(this)}});e.exports={Operand:o,Variable:a,Opcode:_,Stopper:h,Pauser:c,BrancherLogic:u,Brancher:l,BrancherStorer:m,Storer:f,Caller:d,CallerStorer:p,Context:g,RoutineContext:v,opcode_builder:r}},{"../common/utils.js":3}],2:[function(t,e){function r(t,e){return t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3)}function s(t){return String.fromCharCode.call(null,255&t>>24,255&t>>16,255&t>>8,255&t)}var n=t("./utils.js"),i=n.Class,o=i.subClass({init:function(t){if(this.type="",this.chunks=[],t){if("FORM"!==t.substr(0,4))throw Error("Not an IFF file");this.type=t.substr(8,4);for(var e,s=12,n=t.length;n>s;){if(e=r(t,s+4),0>e||e+s>n)throw Error("IFF chunk out of range");this.chunks.push({type:t.substr(s,4),offset:s,data:t.substr(s+8,e)}),s+=8+e,e%2&&s++}}},write:function(){for(var t,e,r=this.type,n=0,i=this.chunks.length;i>n;)t=this.chunks[n++],e=t.data,r+=t.type+s(e.length)+e,e.length%2&&(r+="\0");return"FORM"+s(r.length)+r}}),a=o.subClass({init:function(t){if(this.super.init.call(t),t){if("IFZS"!==this.type)throw Error("Not a Quetzal savefile");for(var e,r,s=0,n=this.chunks.length;n>s;)e=this.chunks[s].type,r=this.chunks[s++].data,"CMem"===e||"UMem"===e?(this.memory=t,this.compressed="CMem"===e):"Stks"===e?this.stacks=t:"IFhd"===e&&(this.release=r.slice(0,2),this.serial=r.slice(2,8),this.checksum=r.slice(8,10),this.pc=r[10]<<16|r[11]<<8|r[12])}},write:function(){this.type="IFZS";var t=this.pc,e=this.release.concat(this.serial,this.checksum,255&t>>16,255&t>>8,255&t);return this.chunks=[{type:"IFhd",data:e},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this.super.write.call(this)}});e.exports={IFF:o,Quetzal:a}},{"./utils.js":3}],3:[function(t,e){function r(){for(var t,e,r=arguments[0],s=1;arguments.length>s;){t=arguments[s++];for(e in t)r[e]=t[e]}return r}function s(){}function n(t){return r(new DataView(t),{getBuffer8:function(t,e){return new Uint8Array(this.buffer.slice(t,t+e))},getBuffer16:function(t,e){return new Uint16Array(this.buffer.slice(t,t+2*e))},setBuffer8:function(t,e){new Uint8Array(this.buffer).set(e,t)}})}function i(t){return t<<16>>16}function o(t){return 65535&t}function a(t){for(var e=0,r=t.length,s=[];r>e;)s[e/2]=t[e++]<<8|t[e++];return s}s.subClass=function(t){function e(){this.init&&this.init.apply(this,arguments)}return e.prototype=r(Object.create(this.prototype),t),e.subClass=this.subClass,e.super=e.prototype.super=this.prototype,e},e.exports={extend:r,Class:s,MemoryView:n,U2S16:i,S2U16:o,byte_to_word:a}},{}],4:[function(t,e,r){var s=t("./common/utils.js"),n=s.Class,i=s.extend,o={init:function(){this.jit={},this.env={width:80}},inputEvent:function(t){var e=this.m,r=t.code;if(!t.env||(i(this.env,t.env),r)){if("load"===r)return this.data=new Uint8Array(t.data),void 0;this.orders=[],"restart"===r&&this.restart(),"save"===r&&this.save_restore_result(t.result||1),"restore"===r&&(this.m||this.restart(),t.data?this.restore_file(t.data):this.save_restore_result(0)),"read"===r&&this.handle_input(t),"char"===r&&this.variable(this.read_data.storer,this.keyinput(t.response)),"get_cursor"===r&&(e.setUint16(t.addr,t.pos[0]+1),e.setUint16(t.addr+2,t.pos[1]+1)),this.run()}},run:function(){var t,e,r=new Date,s=0;for(this.stop=0;!this.stop;)if(t=this.pc,this.jit[t]||this.compile(),e=this.jit[t](this),isNaN(e)||this.ret(e),0===++s%5e4&&new Date-r>5e3)return this.act("tick"),void 0},compile:function(){var t=this.disassemble(),e,r;this.env.debug?(e=""+t,r=eval("(0,function JIT_"+t.pc+"(e){"+e+"})"),r.context=t,r.code=e,t.name&&(r.name=t.name),this.jit[t.pc]=r):this.jit[t.pc]=Function("e",""+t),t.pc<this.staticmem&&this.warn("Caching a JIT function in dynamic memory: "+t.pc)},act:function(t,e){e=e||{},183===t&&(t="restart"),186===t&&(t="quit"),this.ui.flush(),this.ui.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),this.ui.status=[]),e.code=t,this.orders.push(e),this.stop=1,this.outputEvent&&this.outputEvent(this.orders)}},a=n.subClass(i(o,t("./zvm/runtime.js"),t("./zvm/text.js"),t("./zvm/disassembler.js")));e.exports=a},{"./common/utils.js":3,"./zvm/disassembler.js":5,"./zvm/runtime.js":7,"./zvm/text.js":8}],5:[function(t,e){var r=t("../common/ast.js");e.exports.disassemble=function(){function t(t,e){for(var r=0;4>r;r++)e.push((192&t)>>6),t<<=2}for(var e,s,n,i,o,a,_,h=this.m,c=this.opcodes,u=new r.RoutineContext(this,this.pc);;){if(s=e=this.pc,i=h.getUint8(e++),190===i?(a=-1,i=h.getUint8(e++)+1e3):128&i?64&i?(a=-1,32&i||(i&=31)):(a=[(48&i)>>4],3>a[0]&&(i&=207)):(a=[64&i?2:1,32&i?2:1],i&=31),!c[i])throw this.log(""+u),this.stop=1,Error("Unknown opcode #"+i+" at pc="+s);for(o=c[i].prototype,-1===a&&(a=[],t(h.getUint8(e++),a),(236===i||250===i)&&t(h.getUint8(e++),a)),_=[],n=0;a.length>n;)0===a[n]&&(_.push(new r.Operand(this,h.getUint16(e))),e+=2),1===a[n]&&_.push(new r.Operand(this,h.getUint8(e++))),2===a[n++]&&_.push(new r.Variable(this,h.getUint8(e++)));if(o.storer&&_.push(new r.Variable(this,h.getUint8(e++))),o.brancher&&(n=h.getUint8(e++),_.push([128&n,64&n?63&n:(n<<8|h.getUint8(e++))<<18>>18])),o.printer)for(_.push(e);this.eof>e&&(n=h.getUint8(e),e+=2,!(128&n)););if(this.pc=e,u.ops.push(new c[i](this,u,i,s,e,_)),n=0,o.stopper&&!n)break}return u}},{"../common/ast.js":1}],6:[function(t,e){var r=t("../common/ast.js"),s=r.Variable,n=r.Opcode,i=r.Stopper,o=r.Pauser,a=r.Brancher,_=r.BrancherStorer,h=r.Storer,c=r.Caller,u=r.CallerStorer,l=r.opcode_builder,m=function(t){return""+t},f=new s(this.e,0),d=l(a,function(){return 1}),p=l(h,function(t){return"e.S2U(~"+t+")"}),g=h.subClass({storer:0,post:function(){var t=this.operands,e=t[0],r=e instanceof s;t[0]=new s(this.e,r?e:e.v),(r||0===e.v)&&(t[0].indirect=1),this.storer=142===this.code?t.pop():t.shift(),0===t.length&&t.push(f)},func:m}),v=n.subClass({func:function(t){var e=t.v-1,r=this.code%2?1:-1;return t instanceof s||e>14?"e.incdec("+t+","+r+")":(0>e?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":"e.l["+e+"]=e.S2U(e.l["+e+"]+")+r+")"}}),b=i.subClass({brancher:1,toString:function(){return"e."+(181===this.code?"save":"restore")+"("+(this.pc+1)+")"}});e.exports=function(t){return{1:l(a,function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:l(a,function(t,e){return t.U2S()+"<"+e.U2S()}),3:l(a,function(t,e){return t.U2S()+">"+e.U2S()}),4:l(a,function(t,e){return"e.U2S(e.incdec("+t+",-1))<"+e.U2S()}),5:l(a,function(t,e){return"e.U2S(e.incdec("+t+",1))>"+e.U2S()}),6:l(a,function(){return"e.jin("+this.args()+")"}),7:l(a,function(){return"e.test("+this.args()+")"}),8:l(h,function(){return this.args("|")}),9:l(h,function(){return this.args("&")}),10:l(a,function(){return"e.test_attr("+this.args()+")"}),11:l(n,function(){return"e.set_attr("+this.args()+")"}),12:l(n,function(){return"e.clear_attr("+this.args()+")"}),13:g,14:l(n,function(){return"e.insert_obj("+this.args()+")"}),15:l(h,function(t,e){return"m.getUint16(e.S2U("+t+"+2*"+e.U2S()+"))"}),16:l(h,function(t,e){return"m.getUint8(e.S2U("+t+"+"+e.U2S()+"))"}),17:l(h,function(){return"e.get_prop("+this.args()+")"}),18:l(h,function(){return"e.find_prop("+this.args()+")"}),19:l(h,function(){return"e.find_prop("+this.args(",0,")+")"}),20:l(h,function(){return"e.S2U("+this.args("+")+")"}),21:l(h,function(){return"e.S2U("+this.args("-")+")"}),22:l(h,function(){return"e.S2U("+this.args("*")+")"}),23:l(h,function(t,e){return"e.S2U(parseInt("+t.U2S()+"/"+e.U2S()+"))"}),24:l(h,function(t,e){return"e.S2U("+t.U2S()+"%"+e.U2S()+")"}),25:u,26:c,27:l(n,function(){return"e.ui.set_colour("+this.args()+")"}),28:l(i,function(t,e){return"while(e.call_stack.length>"+e+"){e.call_stack.shift()}return "+t}),128:l(a,function(t){return t+"===0"}),129:l(_,function(t){return"e.get_sibling("+t+")"}),130:l(_,function(t){return"e.get_child("+t+")"}),131:l(h,function(t){return"e.get_parent("+t+")"}),132:l(h,function(t){return"e.get_prop_len("+t+")"}),133:v,134:v,135:l(n,function(t){return"e.print(2,"+t+")"}),136:u,137:l(n,function(t){return"e.remove_obj("+t+")"}),138:l(n,function(t){return"e.print(3,"+t+")"}),139:l(i,function(t){return"return "+t}),140:l(i,function(t){return"e.pc="+t.U2S()+"+"+(this.next-2)}),141:l(n,function(t){return"e.print(2,"+t+"*"+this.e.addr_multipler+")"}),142:g.subClass({storer:1}),143:t?p:c,176:l(i,function(){return"return 1"}),177:l(i,function(){return"return 0"}),178:l(n,function(t){return"e.print(2,"+t+")"},{printer:1}),179:l(i,function(t){return"e.print(2,"+t+");e.print(1,13);return 1"},{printer:1}),180:n,181:b,182:b,183:l(i,function(){return"e.act(183)"}),184:l(i,function(t){return"return "+t},{post:function(){this.operands.push(f)}}),185:t?l(n,function(){return"s.pop()"}):l(h,function(){return"e.call_stack.length"}),186:l(i,function(){return"e.act(186)"}),187:l(n,function(){return"e.print(1,13)"}),188:t?l(i,function(){return"e.pc="+this.next+";e.ui.v3_status();e.act()"}):n,189:d,191:d,224:u,225:l(n,function(t,e,r){return"m.setUint16(e.S2U("+t+"+2*"+e.U2S()+"),"+r+")"}),226:l(n,function(t,e,r){return"m.setUint8(e.S2U("+t+"+"+e.U2S()+"),"+r+")"}),227:l(n,function(){return"e.put_prop("+this.args()+")"}),228:t?l(i,function(){return"e.pc="+this.next+";e.read(0,"+this.args()+")"}):l(o,function(){return"e.read("+this.storer.v+","+this.args()+")"}),229:l(n,function(t){return"e.print(4,"+t+")"}),230:l(n,function(t){return"e.print(0,"+t.U2S()+")"}),231:l(h,function(t){return"e.random("+t.U2S()+")"}),232:l(h,m,{post:function(){this.storer=f},storer:0}),233:g,234:l(n,function(t){return"e.ui.split_window("+t+")"}),235:l(n,function(t){return"e.ui.set_window("+t+")"}),236:u,237:l(n,function(t){return"e.ui.erase_window("+t.U2S()+")"}),238:l(n,function(t){return"e.ui.erase_line("+t+")"}),239:l(n,function(){return"e.ui.set_cursor("+this.args()+")"}),240:l(o,function(t){return"e.ui.get_cursor("+t+")"}),241:l(n,function(t){return"e.ui.set_style("+t+")"}),242:n,243:l(n,function(){return"e.output_stream("+this.args()+")"}),244:n,245:n,246:l(o,function(){return"e.read_char("+this.storer.v+","+(this.args()||"1")+")"}),247:l(_,function(){return"e.scan_table("+this.args()+")"}),248:p,249:c,250:c,251:l(n,function(){return"e.tokenise("+this.args()+")"}),252:l(n,function(){return"e.encode_text("+this.args()+")"}),253:l(n,function(){return"e.copy_table("+this.args()+")"}),254:l(n,function(){return"e.print_table("+this.args()+")"}),255:l(a,function(t){return t+"<=e.call_stack[0][4]"}),1e3:l(o,function(){return"e.save("+(this.next-1)+")"}),1001:l(o,function(){return"e.restore("+(this.next-1)+")"}),1002:l(h,function(t,e){return"e.S2U(e.log_shift("+t+","+e.U2S()+"))"}),1003:l(h,function(t,e){return"e.S2U(e.art_shift("+t.U2S()+","+e.U2S()+"))"}),1004:l(h,function(t){return"e.ui.set_font("+t+")"}),1009:l(h,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:l(n,function(){return"if(e.restore_undo())return"},{storer:1}),1011:l(n,function(t){return"e.print(1,"+t+")"}),1012:l(h,function(){return 3}),1013:l(n,function(){return"e.ui.set_true_colour("+this.args()+")"}),1014:n.subClass({brancher:1}),1030:l(h,function(){return"e.gestalt("+this.args()+")"})}}},{"../common/ast.js":1}],7:[function(t,e){var r=t("../common/utils.js"),s=r.extend,n=r.U2S16,i=r.S2U16,o=r.byte_to_word,a=t("../common/file.js");e.exports={art_shift:function(t,e){return e>0?t<<e:t>>-e},call:function(t,e,r,s){if(0===t)return e>=0&&this.variable(e,0),this.pc=r;var n,i,o=this.l.length,a=s.length;for(this.pc=t*this.addr_multipler,i=this.m.getUint8(this.pc++),s=s.slice(0,i),n=s.length;i>n;n++)s.push(this.version3?this.m.getUint16(this.pc+2*n):0);this.version3&&(this.pc+=2*i),this.l=s.concat(this.l),this.call_stack.unshift([r,e,i,this.s.length,a,o])},clear_attr:function(t,e){var r=0|this.objects+(this.version3?9:14)*t+e/8;this.m.setUint8(r,this.m.getUint8(r)&~(128>>e%8))},copy_table:function(t,e,r){r=n(r);var s=this.m,i=0,o=0>r;if(r=Math.abs(r),0!==e)if(o)for(;r>i;)s.setUint8(e+i,s.getUint8(t+i++));else s.setBuffer8(e,s.getBuffer8(t,r));else for(;r>i;)s.setUint8(t+i++,0)},encode_text:function(t,e,r,s){this.m.setBuffer8(s,this.encode(this.m.getBuffer8(t+r,e)))},extension_table:function(t,e){var r=this.extension;return!r||t>this.extension_count?0:(r+=2*t,void 0===e?this.m.getUint16(r):(this.e.setUint16(r,e),void 0))},find_prop:function(t,e,r){var s,n,i=this.m,o=this.version3,a=0,_=i.getUint16(this.objects+(o?9:14)*t+(o?7:12));for(_+=2*i.getUint8(_)+1;;){if(s=i.getUint8(_),n=s&(o?31:63),a===r)return n;if(n===e)return _+(!o&&128&s?2:1);if(e>n)return 0;a=n,o?_+=(s>>5)+2:128&s?(n=63&i.getUint8(_+1),_+=n?n+2:66):_+=64&s?3:2}},gestalt:function(t){switch(t){case 1:return 258;case 8192:return 1;case 8193:case 8194:return 2}return 0},get_child:function(t){return this.version3?this.m.getUint8(this.objects+9*t+6):this.m.getUint16(this.objects+14*t+10)},get_sibling:function(t){return this.version3?this.m.getUint8(this.objects+9*t+5):this.m.getUint16(this.objects+14*t+8)},get_parent:function(t){return this.version3?this.m.getUint8(this.objects+9*t+4):this.m.getUint16(this.objects+14*t+6)},get_prop:function(t,e){var r,s=this.m,n=this.find_prop(t,e);return n?(r=s.getUint8(n-1),s[(this.version3?r>>5:64&r)?"getUint16":"getUint8"](n)):s.getUint16(this.properties+2*(e-1))},get_prop_len:function(t){if(0===t)return 0;var e=this.m.getUint8(t-1);return this.version3?(e>>5)+1:128&e?(e&=63,0===e?64:e):64&e?2:1},handle_input:function(t){var e=this.m,r=this.read_data,s=t.response;this._print(s+"\r"),s=this.text_to_zscii(s.toLowerCase()),s.length>r.len&&(s=s.slice(0,r.len)),this.version3?(s.push(0),e.setBuffer8(r.buffer+1,s)):(e.setUint8(r.buffer+1,s.length),e.setBuffer8(r.buffer+2,s),this.variable(r.storer,isNaN(t.terminator)?13:t.terminator)),r.parse&&this.tokenise(r.buffer,r.parse)},incdec:function(t,e){var r,s;return 0===t?(r=i(this.s.pop()+e),this.s.push(r),r):15>--t?this.l[t]=i(this.l[t]+e):(s=this.globals+2*(t-15),r=this.m.getUint16(s)+e,this.m.setUint16(s,r),r)},indirect:function(t,e){return 0===t?arguments.length>1?this.s[this.s.length-1]=e:this.s[this.s.length-1]:this.variable(t,e)},insert_obj:function(t,e){this.remove_obj(t),this.set_family(t,e,e,t,t,this.get_child(e))},jeq:function(){for(var t=1;arguments.length>t;)if(arguments[t++]===arguments[0])return 1},jin:function(t,e){return this.get_parent(t)===e},log:function(){this.env.debug&&"undefined"!=typeof console&&console.log&&console.log.apply(console,arguments)},log_shift:function(t,e){return e>0?t<<e:t>>>-e},output_stream:function(t,e){if(t=n(t),1===t&&(this.streams[0]=1),-1===t&&(this.log("Disabling stream one - it actually happened!"),this.streams[0]=0),3===t&&this.streams[2].unshift([e,""]),-3===t){var r=this.streams[2].shift(),s=this.text_to_zscii(r[1]);this.m.setUint16(r[0],s.length),this.m.setBuffer8(r[0]+2,s)}},_print:function(t){if(this.streams[2].length)this.streams[2][0][1]+=t;else if(this.streams[0]){var e=2&this.m.getUint8(17);e!==(2&this.ui.mono)&&(253&this.ui.mono||this.ui.flush(),this.ui.mono^=2),this.ui.buffer+=t}},print:function(t,e){if(0===t&&(e=""+e),1===t&&(e=String.fromCharCode(e)),2===t&&(e=this.jit[e]||this.decode(e)),3===t){var r=this.m.getUint16(this.objects+(this.version3?9:14)*e+(this.version3?7:12));e=this.decode(r+1,2*this.m.getUint8(r))}if(4===t){if(!this.unicode_table[e])return;e=this.unicode_table[e]}this._print(e)},print_table:function(t,e,r,s){r=r||1,s=s||0;for(var n=0;r>n++;)this._print(this.zscii_to_text(this.m.getBuffer8(t,e))+(r>n?"\r":"")),t+=e+s},put_prop:function(t,e,r){var s,n=this.m,i=this.find_prop(t,e);i&&(s=n.getUint8(i-1),n[(this.version3?s>>5:64&s)?"setUint16":"setUint8"](i,r))},random:function(t){var e=this.xorshift_seed;return 1>t?(this.xorshift_seed=t,0):0===e?0|1+Math.random()*t:(e^=e<<13,e^=e>>17,this.xorshift_seed=e^=e<<5,1+(32767&e)%t)},read:function(t,e,r,s,n){var i,o=this.m.getUint8(e);this.version3?(o--,i={len:o},this.ui.v3_status()):i={len:o,initiallen:this.m.getUint8(e+1),time:s},this.read_data={buffer:e,len:o,parse:r,routine:n,storer:t},this.act("read",i)},read_char:function(t,e,r,s){this.read_data={routine:s,storer:t},this.act("char",{time:r})},remove_obj:function(t){var e,r,s,n=this.get_parent(t);if(0!==n)if(e=this.get_child(n),r=this.get_sibling(t),e===t)this.set_family(t,0,n,r);else{for(;;){if(s=this.get_sibling(e),s===t)break;e=s}this.set_family(t,0,0,0,e,r)}},restart:function(){var e=r.MemoryView(this.data.buffer.slice()),n=e.getUint8(0),i=3===n,o=i?2:5===n?4:8,a=e.getUint16(10),_=e.getUint16(54);if(3!==n&&5!==n&&8!==n)throw Error("Unsupported Z-Machine version: "+n);this.m&&e.setUint8(17,this.m.getUint8(17)),s(this,{m:e,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:n,version3:3===n,pc:e.getUint16(6),properties:a,objects:a+(i?53:112),globals:e.getUint16(12),staticmem:e.getUint16(14),eof:(e.getUint16(26)||65536)*o,extension:_,extension_count:_?e.getUint16(_):0,addr_multipler:o,opcodes:t("./opcodes.js")(i)}),this.ui=new(t("./ui.js"))(this),this.init_text(),this.update_header()},restore:function(t){this.save_restore_pc=t,this.act("restore")},restore_file:function(t){var e,r,s=this.m,n=new a.Quetzal(t),i=n.memory,_=n.stacks,h=s.getUint8(17),c=0,u=0,l=[],m=[];if(s.setBuffer8(0,this.data.slice(0,this.staticmem)),n.compressed)for(;i.length>c;)e=i[c++],0===e?u+=1+i[c++]:s.setUint8(u,e^this.data[u++]);else s.setBuffer8(0,i);for(s.setUint8(17,h),c=6,e=_[c++]<<8|_[c++],r=o(_.slice(c,e));_.length>c;){for(l.unshift([_[c++]<<16|_[c++]<<8|_[c++],0,0,r.length,0,m.length]),l[0][1]=16&_[c]?-1:_[c+1],l[0][2]=15&_[c],c+=2,e=_[c++];e;)l[0][4]++,e>>=1;e=2*(_[c++]<<8|_[c++]),m=o(_.slice(c,c+=2*l[0][2])).concat(m),r=r.concat(o(_.slice(c,c+=e)))}this.call_stack=l,this.l=m,this.s=r,this.update_header(),this.save_restore_pc=n.pc,this.save_restore_result(2),this.version3&&this.ui.split_window(0)},restore_undo:function(){if(0===this.undo.length)return 0;var t=this.undo.pop();return this.pc=t[0],t[2][17]=this.m.getUint8(17),this.m.setBuffer8(0,t[2]),this.l=t[3],this.s=t[4],this.call_stack=t[5],this.variable(t[1],2),1},ret:function(t){var e=this.call_stack.shift(),r=e[1];this.pc=e[0],this.l=this.l.slice(this.l.length-e[5]),this.s.length=e[3],r>=0&&this.variable(r,0|t)},save:function(t){var e,r,s,n,i,o=this.m,_=this.s,h=this.l,c=new a.Quetzal,u=[],l=0,m=this.call_stack.reverse(),f=[0,0,0,0,0,0];for(c.release=o.getBuffer8(2,2),c.serial=o.getBuffer8(18,6),c.checksum=o.getBuffer8(28,2),c.pc=t,c.compressed=1,e=0;this.staticmem>e;e++)s=o.getUint8(e)^this.data[e],0===s?256===++l&&(u.push(0,255),l=0):(l&&(u.push(0,l-1),l=0),u.push(s));for(c.memory=u,f.push(m[0][3]>>8,255&m[0][3]),r=0;m[0][3]>r;r++)f.push(_[r]>>8,255&_[r]);for(e=0;m.length>e;e++){for(n=m[e],i=(m[e+1]?m[e+1][3]:_.length)-n[3],f.push(n[0]>>16,255&n[0]>>8,255&n[0],n[2]|(0>n[1]?16:0),0>n[1]?0:n[1],(1<<n[4])-1,i>>8,255&i),r=h.length-n[5]-n[2];h.length-n[5]>r;r++)f.push(h[r]>>8,255&h[r]);for(r=n[3];n[3]+i>r;r++)f.push(_[r]>>8,255&_[r])}m.reverse(),c.stacks=f,this.save_restore_pc=t,this.act("save",{data:c.write()})},save_restore_result:function(t){var e,r,s,n=this.m,i=this.save_restore_pc;this.version3?(e=n.getUint8(i++),r=128&e,s=64&e?63&e:(e<<8|n.getUint8(i++))<<18>>18,!t==!r?0===s||1===s?this.ret(s):this.pc=s+i-2:this.pc=i):(this.variable(n.getUint8(i++),t),this.pc=i)},save_undo:function(t,e){return this.undo.push([t,e,this.m.getBuffer8(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]),1},scan_table:function(t,e,r,s){s=s||130;var n=128&s?"getUint16":"getUint8";for(s&=127,r=e+r*s;r>e;){if(this.m[n](e)===t)return e;e+=s}return 0},set_attr:function(t,e){var r=0|this.objects+(this.version3?9:14)*t+e/8;this.m.setUint8(r,this.m.getUint8(r)|128>>e%8)},set_family:function(t,e,r,s,n,i){var o=this.m,a=this.objects;this.version3?(o.setUint8(a+9*t+4,e),r&&o.setUint8(a+9*r+6,s),n&&o.setUint8(a+9*n+5,i)):(o.setUint16(a+14*t+6,e),r&&o.setUint16(a+14*r+10,s),n&&o.setUint16(a+14*n+8,i))},test:function(t,e){return t&e===e},test_attr:function(t,e){return 128&this.m.getUint8(0|this.objects+(this.version3?9:14)*t+e/8)<<e%8},update_header:function(){var t=this.m;return this.xorshift_seed=0,this.version3?t.setUint8(1,96|t.getUint8(1)):(t.setUint8(1,29|(this.env.timed?128:0)),t.setUint8(17,87&t.getUint8(17)),t.setUint8(32,255),t.setUint8(33,this.env.width),t.setUint16(34,this.env.width),t.setUint16(36,255),t.setUint16(38,257),t.setUint16(50,258),this.extension_table(4,0),this.ui.update_header(),void 0)},variable:function(t,e){var r,s=void 0!==e;if(0===t){if(!s)return this.s.pop();this.s.push(e)}else if(15>--t){if(!s)return this.l[t];this.l[t]=e}else{if(r=this.globals+2*(t-15),!s)return this.m.getUint16(r);this.m.setUint16(r,e)}return e},warn:function(){this.env.debug&&"undefined"!=typeof console&&console.warn&&console.warn.apply(console,arguments)},U2S:n,S2U:i}},{"../common/file.js":2,"../common/utils.js":3,"./opcodes.js":6,"./ui.js":9}],8:[function(t,e){for(var r={8:8,13:13,27:27,37:131,38:129,39:132,40:130},s=96;106>s;)r[s]=49+s++;for(s=112;124>s;)r[s]=21+s++;e.exports={init_text:function(){function t(t){for(var e=[[],[],[]],s=0;78>s;)e[0|s/26][s%26]=t[s++];e[2][1]=13,r.alphabets=e}function e(t){for(var e={13:"\r"},s={13:13},n=0;t.length>n;)e[155+n]=String.fromCharCode(t[n]),s[t[n]]=155+n++;for(n=32;127>n;)e[n]=String.fromCharCode(n),s[n]=n++;r.unicode_table=e,r.reverse_unicode_table=s}var r=this,s=this.m,n=!this.version3&&s.getUint16(52),i=this.extension_table(3),o=i&&s.getUint8(i++);this.abbr_addr=s.getUint16(24),t(n?s.getBuffer8(n,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),e(i?s.getBuffer16(i,o):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=s.getUint16(8),this.parse_dict(this.dict)},decode:function(t,e){var r,s,n,i,o=this.m,a=t,_=[],h=0,c=0,u=[],l=[],m=0;if(this.jit[t])return this.jit[t];for(e=e?e+t:this.eof;e>t&&(r=o.getUint16(t),t+=2,_.push(31&r>>10,31&r>>5,31&r),!(32768&r)););for(;_.length>h;){if(s=_[h++],0===s)u.push(32);else if(4>s)n=1,u.push(-1),l.push("\ue000+this.abbr("+(32*(s-1)+_[h++])+")+\ue000");else if(6>s)c=s;else if(2===c&&6===s){if(_.length>h+1)if(i=_[h++]<<5|_[h++],768>i)u.push(i);else{for(i-=767,m+=i,r=h,h=h%3+3;i--;)u.push(-1),l.push(String.fromCharCode(_[h]<<10|_[h+1]<<5|_[h+2])),_[h++]=_[h++]=_[h++]=32;h=r}}else 32>s&&u.push(this.alphabets[c][s-6]);c=4>c?0:c-3,0===h%3&&(h+=m,m=0)}return u=this.zscii_to_text(u,l),n&&(u={toString:Function('return"'+u.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"').bind(this)}),a>=this.staticmem&&(this.jit[a]=u),u},encode:function(t){for(var e,r,s=this.alphabets,n=[],i=this.version3?6:9,o=0,a=[];i>n.length;)e=t[o++],32===e?n.push(0):(r=s[0].indexOf(e))>=0?n.push(r+6):(r=s[1].indexOf(e))>=0?n.push(4,r+6):(r=s[2].indexOf(e))>=0?n.push(5,r+6):(r=this.reverse_unicode_table[e])?n.push(5,6,r>>5,31&r):void 0===e&&n.push(5);for(n.length=i,o=0;i>o;)a.push(n[o++]<<2|n[o]>>3,(7&n[o++])<<5|n[o++]);return a[a.length-2]|=128,a},zscii_to_text:function(t,e){for(var r,s=0,n=t.length,i=0,o="";n>s;)r=t[s++],-1===r&&(o+=e[i++]),(r=this.unicode_table[r])&&(o+=r);return o},text_to_zscii:function(t,e){for(var r,s=[],n=0,i=t.length;i>n;)r=t.charCodeAt(n++),e||(r=this.reverse_unicode_table[r]||63),s.push(r);return s},parse_dict:function(t){var e,r,s=this.m,n=t,i={},o=s.getUint8(t++);for(i.separators=Array.prototype.slice.call(s.getBuffer8(t,o)),t+=o,e=s.getUint8(t++),r=t+2+e*s.getUint16(t),t+=2;r>t;)i[Array.prototype.toString.call(s.getBuffer8(t,this.version3?4:6))]=t,t+=e;return this.dictionaries[n]=i,i},abbr:function(t){return this.decode(2*this.m.getUint16(this.abbr_addr+2*t))},tokenise:function(t,e,r,s){r=r||this.dict,r=this.dictionaries[r]||this.parse_dict(r);var n,i,o,a,_=this.m,h=1e3,c=1,u=r.separators,l=[],m=0;for(this.version3||(h=_.getUint8(t+c++)+2);h>c&&(n=_.getUint8(t+c),0!==n);)32===n||u.indexOf(n)>=0?(32!==n&&l.push([[n],c]),i=null):(i||(l.push([[],c]),i=l[l.length-1][0]),i.push(n)),c++;for(o=Math.min(l.length,_.getUint8(e));o>m;)a=r[""+this.encode(l[m][0])],(!s||a)&&(_.setUint16(e+2+4*m,a||0),_.setUint8(e+4+4*m,l[m][0].length),_.setUint8(e+5+4*m,l[m][1])),m++;_.setUint8(e+1,m)},keyinput:function(t){return r[t.keyCode]||this.reverse_unicode_table[t.charCode]||63}}},{}],9:[function(t,e){var r=t("../common/utils.js"),s=r.Class;e.exports=s.subClass({init:function(t){this.e=t,this.buffer="",r.extend(this,this.formatters[t.env.formatter]||{}),this.e.env.debug&&(this.reverse=0,this.bold=0,this.italic=0,this.fg=void 0,this.bg=void 0),this.time=2&t.m.getUint8(1),this.mono=2&t.m.getUint8(17),this.process_colours(),this.currentwin=0,this.status=[],t.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",bg:this.bg})},erase_line:function(t){1===t&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(t){this.flush(),1>t&&this.clear_window(),-1===t&&this.split_window(0),(-2===t||1===t)&&this.status.push({code:"clear"})},flush:function(){if(""!==this.buffer){var t={code:"stream",text:this.buffer,props:this.format()};(this.currentwin?this.status:this.e.orders).push(t),this.buffer=""}},format:function(){var t,e={},r=[],s=this.fg,n=this.bg;return this.bold&&r.push("zvm-bold"),this.italic&&r.push("zvm-italic"),this.mono&&r.push("zvm-mono"),this.reverse&&(t=s,s=n||this.env.bg,n=t||this.env.fg),s!==void 0&&(isNaN(s)?e.css={color:s}:r.push("zvm-fg-"+s)),n!==void 0&&(isNaN(n)?(e.css||(e.css={}),e.css["background-color"]=n):r.push("zvm-bg-"+n)),r.length&&(e["class"]=r.join(" ")),e},get_cursor:function(t){this.status.push({code:"get_cursor",addr:t}),this.e.act()},process_colours:function(){function t(t){var e,r=Math.round,s=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(t);return s[1]?e=[s[1],s[2],s[3]]:(e=[parseInt(s[4],16),parseInt(s[5],16),parseInt(s[6],16)],4===t.length&&(e=[e[0]<<4|e[0],e[1]<<4|e[1],e[2]<<4|e[2]])),r(e[2]/8.226)<<10|r(e[1]/8.226)<<5|r(e[0]/8.226)}var e=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],r=this.e.env.fgcolour,s=this.e.env.bgcolour,n=r?t(r):65535,i=s?t(s):65535,o=e.indexOf(n),a=e.indexOf(i);2>o&&(o=r||2),2>a&&(a=s||9),this.env={fg:o,bg:a,fg_true:n,bg_true:i}},set_colour:function(t,e){this.flush(),1===t&&(this.fg=void 0),t>1&&13>t&&(this.fg=t),1===e&&(this.bg=void 0),e>1&&13>e&&(this.bg=e)},set_cursor:function(t,e){this.flush(),this.status.push({code:"cursor",to:[t-1,e-1]})},set_font:function(t){if(1!==t&&4!==t)return 0;var e=4&this.mono?4:1;return t!==e&&(this.flush(),this.mono^=4),e},set_style:function(t){this.flush(),0===t&&(this.reverse=this.bold=this.italic=0,this.mono&=254),1&t&&(this.reverse=1),2&t&&(this.bold=1),4&t&&(this.italic=1),8&t&&(this.mono|=1)},set_true_colour:function(t,e){function r(t){var e=Math.round(8.226*(31&t))<<16|Math.round(8.226*((992&t)>>5))<<8|Math.round(8.226*((31744&t)>>10));for(e=e.toString(16);6>e.length;)e="0"+e;return"#"+e}this.flush(),65535===t?this.fg=void 0:32768>t&&(this.fg=r(t)),65535===e?this.bg=void 0:32768>e&&(this.bg=r(e))},set_window:function(t){this.flush(),this.currentwin=t,this.e.orders.push({code:"find",name:t?"status":"main"}),t&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(t){this.flush(),this.status.push({code:"height",lines:t}),this.e.version3&&this.status.push({code:"clear"})},update_header:function(){var t=this.e.m;t.setUint8(44,isNaN(this.env.bg)?1:this.env.bg),t.setUint8(45,isNaN(this.env.fg)?1:this.env.fg),this.e.extension_table(5,this.env.fg_true),this.e.extension_table(6,this.env.bg_true)},v3_status:function(){var t,e=this.e,r=e.env.width,s=e.m.getUint16(e.globals+2),n=e.m.getUint16(e.globals+4);this.set_window(1),this.set_style(1),e._print(Array(r+1).join(" ")),this.set_cursor(1,1),t=this.time?"Time: "+(0===s%12?12:s%12)+":"+(10>n?"0":"")+n+" "+(s>11?"PM":"AM"):"Score: "+s+"  Turns: "+n,e.print(3,e.m.getUint16(e.globals)),this.buffer=" "+this.buffer.slice(0,r-t.length-4),this.set_cursor(1,r-t.length),e._print(t),this.set_style(0),this.set_window(0)
},formatters:{}})},{"../common/utils.js":3}]},{},[4])(4)});